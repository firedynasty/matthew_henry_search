<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matthew Henry Commentary Search</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    /* Light mode (default) */
    body {
      background: #f5f5f5;
      color: #333;
    }

    /* Dark mode */
    body.dark-mode {
      background: #1a1a2e;
      color: #eee;
    }

    .header-row {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
    }

    body.dark-mode h1 {
      color: #fff;
    }

    .theme-toggle {
      position: absolute;
      right: 0;
      padding: 8px 12px;
      font-size: 14px;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
    }

    body.dark-mode .theme-toggle {
      background: #16213e;
      color: #eee;
      border-color: #444;
    }

    .theme-toggle:hover {
      background: #d0d0d0;
    }

    body.dark-mode .theme-toggle:hover {
      background: #1f2b4a;
    }

    .search-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      margin: 0 auto 24px auto;
    }

    .input-row {
      display: flex;
      gap: 8px;
    }

    input[type="text"], select {
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      color: #333;
    }

    body.dark-mode input[type="text"], body.dark-mode select {
      border-color: #444;
      background: #16213e;
      color: #fff;
    }

    input[type="text"] {
      flex: 1;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #4a9eff;
    }

    select {
      min-width: 120px;
    }

    .button-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
    }

    button[type="submit"] {
      padding: 10px 20px;
      font-size: 14px;
      background: #4a9eff;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button[type="submit"]:hover {
      background: #3a8eef;
    }

    button[type="submit"]:disabled {
      background: #999;
      cursor: not-allowed;
    }

    body.dark-mode button[type="submit"]:disabled {
      background: #555;
    }

    .stats {
      text-align: center;
      color: #666;
      margin-bottom: 16px;
      font-size: 14px;
    }

    body.dark-mode .stats {
      color: #888;
    }

    .results {
      max-width: 800px;
      margin: 0 auto;
    }

    .result-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    body.dark-mode .result-item {
      background: #16213e;
      border-color: transparent;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .result-title {
      font-weight: 600;
      color: #2070c0;
      font-size: 14px;
      text-decoration: none;
    }

    a.result-title:hover {
      text-decoration: underline;
    }

    body.dark-mode .result-title {
      color: #4a9eff;
    }

    .result-book {
      background: #e8f0f8;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
    }

    body.dark-mode .result-book {
      background: #0f3460;
      color: #aaa;
    }

    .result-count {
      color: #666;
      font-size: 12px;
    }

    body.dark-mode .result-count {
      color: #888;
    }

    .context {
      font-size: 14px;
      line-height: 1.6;
      color: #444;
      margin: 8px 0;
      padding: 8px;
      background: #f0f4f8;
      border-radius: 4px;
      border-left: 3px solid #4a9eff;
    }

    body.dark-mode .context {
      color: #ccc;
      background: #0f3460;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
    }

    body.dark-mode .loading {
      color: #888;
    }

    .error {
      background: #ffebeb;
      color: #c44;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    body.dark-mode .error {
      background: #5c1a1a;
      color: #ff8888;
    }

    .no-results {
      text-align: center;
      color: #666;
      padding: 40px;
    }

    body.dark-mode .no-results {
      color: #888;
    }

    .help {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }

    body.dark-mode .help {
      color: #888;
    }

    .help code {
      background: #e8f0f8;
      padding: 2px 6px;
      border-radius: 4px;
      color: #2070c0;
    }

    body.dark-mode .help code {
      background: #16213e;
      color: #4a9eff;
    }

    .font-controls {
      display: flex;
      gap: 4px;
    }

    .font-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      font-size: 18px;
      font-weight: bold;
      background: #e0e0e0;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.dark-mode .font-btn {
      background: #16213e;
      color: #eee;
      border-color: #444;
    }

    .font-btn:hover {
      background: #d0d0d0;
    }

    body.dark-mode .font-btn:hover {
      background: #1f2b4a;
    }
  </style>
</head>
<body>
  <div class="header-row">
    <h1>Matthew Henry Commentary</h1>
    <button class="theme-toggle" onclick="toggleTheme()">Dark Mode</button>
  </div>

  <form class="search-form" onsubmit="doSearch(event)">
    <div class="input-row">
      <input type="text" id="keyword" placeholder="Search keyword (e.g., love, grace)" autofocus>
      <select id="book">
        <option value="">All Books</option>
        <optgroup label="Old Testament">
          <option value="genesis">Genesis</option>
          <option value="exodus">Exodus</option>
          <option value="leviticus">Leviticus</option>
          <option value="numbers">Numbers</option>
          <option value="deuteronomy">Deuteronomy</option>
          <option value="joshua">Joshua</option>
          <option value="judges">Judges</option>
          <option value="ruth">Ruth</option>
          <option value="1samuel">1 Samuel</option>
          <option value="2samuel">2 Samuel</option>
          <option value="1kings">1 Kings</option>
          <option value="2kings">2 Kings</option>
          <option value="1chronicles">1 Chronicles</option>
          <option value="2chronicles">2 Chronicles</option>
          <option value="ezra">Ezra</option>
          <option value="nehemiah">Nehemiah</option>
          <option value="esther">Esther</option>
          <option value="job">Job</option>
          <option value="psalms">Psalms</option>
          <option value="proverbs">Proverbs</option>
          <option value="ecclesiastes">Ecclesiastes</option>
          <option value="song">Song of Solomon</option>
          <option value="isaiah">Isaiah</option>
          <option value="jeremiah">Jeremiah</option>
          <option value="lamentations">Lamentations</option>
          <option value="ezekiel">Ezekiel</option>
          <option value="daniel">Daniel</option>
          <option value="hosea">Hosea</option>
          <option value="joel">Joel</option>
          <option value="amos">Amos</option>
          <option value="obadiah">Obadiah</option>
          <option value="jonah">Jonah</option>
          <option value="micah">Micah</option>
          <option value="nahum">Nahum</option>
          <option value="habakkuk">Habakkuk</option>
          <option value="zephaniah">Zephaniah</option>
          <option value="haggai">Haggai</option>
          <option value="zechariah">Zechariah</option>
          <option value="malachi">Malachi</option>
        </optgroup>
        <optgroup label="New Testament">
          <option value="matthew">Matthew</option>
          <option value="mark">Mark</option>
          <option value="luke">Luke</option>
          <option value="john">John</option>
          <option value="acts">Acts</option>
          <option value="romans">Romans</option>
          <option value="1corinthians">1 Corinthians</option>
          <option value="2corinthians">2 Corinthians</option>
          <option value="galatians">Galatians</option>
          <option value="ephesians">Ephesians</option>
          <option value="philippians">Philippians</option>
          <option value="colossians">Colossians</option>
          <option value="1thessalonians">1 Thessalonians</option>
          <option value="2thessalonians">2 Thessalonians</option>
          <option value="1timothy">1 Timothy</option>
          <option value="2timothy">2 Timothy</option>
          <option value="titus">Titus</option>
          <option value="philemon">Philemon</option>
          <option value="hebrews">Hebrews</option>
          <option value="james">James</option>
          <option value="1peter">1 Peter</option>
          <option value="2peter">2 Peter</option>
          <option value="1john">1 John</option>
          <option value="2john">2 John</option>
          <option value="3john">3 John</option>
          <option value="jude">Jude</option>
          <option value="revelation">Revelation</option>
        </optgroup>
      </select>
    </div>
    <div class="button-row">
      <button type="submit" id="searchBtn">Search</button>
      <div class="font-controls">
        <button type="button" class="font-btn" onclick="changeFontSize(-1)">-</button>
        <button type="button" class="font-btn" onclick="changeFontSize(1)">+</button>
      </div>
    </div>
  </form>

  <div id="output">
    <div class="help">
      <p>Search through Matthew Henry's Complete Commentary on the Whole Bible.</p>
      <p>Examples:</p>
      <ul>
        <li><code>love</code> - search all books</li>
        <li><code>grace</code> + Psalms - search only Psalms</li>
        <li><code>eternal life</code> + John - search Gospel of John</li>
      </ul>
    </div>
  </div>

  <script>
    const API_URL = '/.netlify/functions/search';

    function toggleTheme() {
      const body = document.body;
      const btn = document.querySelector('.theme-toggle');
      body.classList.toggle('dark-mode');
      if (body.classList.contains('dark-mode')) {
        btn.textContent = 'Light Mode';
        localStorage.setItem('theme', 'dark');
      } else {
        btn.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'light');
      }
    }

    // Font size control
    let currentFontSize = parseInt(localStorage.getItem('fontSize')) || 14;

    function changeFontSize(delta) {
      currentFontSize = Math.max(10, Math.min(24, currentFontSize + delta));
      applyFontSize();
      localStorage.setItem('fontSize', currentFontSize);
    }

    function applyFontSize() {
      const output = document.getElementById('output');
      output.style.fontSize = currentFontSize + 'px';
    }

    // Load saved preferences
    (function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.querySelector('.theme-toggle').textContent = 'Light Mode';
      }
      // Apply saved font size
      applyFontSize();
    })();

    const BIBLE_APP_URL = 'https://cdpn.io/pen/debug/KwVxmKR';

    // Map display book names to URL parameter format (lowercase, no spaces)
    const bookToParam = {
      'Genesis': 'genesis',
      'Exodus': 'exodus',
      'Leviticus': 'leviticus',
      'Numbers': 'numbers',
      'Deuteronomy': 'deuteronomy',
      'Joshua': 'joshua',
      'Judges': 'judges',
      'Ruth': 'ruth',
      '1 Samuel': '1samuel',
      '2 Samuel': '2samuel',
      '1 Kings': '1kings',
      '2 Kings': '2kings',
      '1 Chronicles': '1chronicles',
      '2 Chronicles': '2chronicles',
      'Ezra': 'ezra',
      'Nehemiah': 'nehemiah',
      'Esther': 'esther',
      'Job': 'job',
      'Psalms': 'psalms',
      'Proverbs': 'proverbs',
      'Ecclesiastes': 'ecclesiastes',
      'Song of Solomon': 'song',
      'Isaiah': 'isaiah',
      'Jeremiah': 'jeremiah',
      'Lamentations': 'lamentations',
      'Ezekiel': 'ezekiel',
      'Daniel': 'daniel',
      'Hosea': 'hosea',
      'Joel': 'joel',
      'Amos': 'amos',
      'Obadiah': 'obadiah',
      'Jonah': 'jonah',
      'Micah': 'micah',
      'Nahum': 'nahum',
      'Habakkuk': 'habakkuk',
      'Zephaniah': 'zephaniah',
      'Haggai': 'haggai',
      'Zechariah': 'zechariah',
      'Malachi': 'malachi',
      'Matthew': 'matthew',
      'Mark': 'mark',
      'Luke': 'luke',
      'John': 'john',
      'Acts': 'acts',
      'Romans': 'romans',
      '1 Corinthians': '1corinthians',
      '2 Corinthians': '2corinthians',
      'Galatians': 'galatians',
      'Ephesians': 'ephesians',
      'Philippians': 'philippians',
      'Colossians': 'colossians',
      '1 Thessalonians': '1thessalonians',
      '2 Thessalonians': '2thessalonians',
      '1 Timothy': '1timothy',
      '2 Timothy': '2timothy',
      'Titus': 'titus',
      'Philemon': 'philemon',
      'Hebrews': 'hebrews',
      'James': 'james',
      '1 Peter': '1peter',
      '2 Peter': '2peter',
      '1 John': '1john',
      '2 John': '2john',
      '3 John': '3john',
      'Jude': 'jude',
      'Revelation': 'revelation'
    };

    // Roman numeral to number conversion
    function romanToNumber(roman) {
      if (!roman) return null;
      roman = roman.toUpperCase().trim();

      const romanNumerals = {
        'I': 1, 'V': 5, 'X': 10, 'L': 50,
        'C': 100, 'D': 500, 'M': 1000
      };

      let result = 0;
      let prevValue = 0;

      for (let i = roman.length - 1; i >= 0; i--) {
        const char = roman[i];
        const value = romanNumerals[char];

        if (!value) return null; // Invalid Roman numeral character

        if (value < prevValue) {
          result -= value;
        } else {
          result += value;
        }
        prevValue = value;
      }

      return result > 0 ? result : null;
    }

    // Extract chapter number from title (e.g., "[Psalms XVI]." -> 16)
    function extractChapter(title) {
      // Match Roman numeral at end: [Book NAME]
      const match = title.match(/\[.+?\s+([IVXLCDM]+)\]/i);
      if (match) {
        return romanToNumber(match[1]);
      }
      // Try Arabic numeral
      const arabicMatch = title.match(/\[.+?\s+(\d+)\]/);
      if (arabicMatch) {
        return parseInt(arabicMatch[1]);
      }
      return null;
    }

    // Create Bible app URL from book name and title
    function getBibleLink(bookName, title) {
      const param = bookToParam[bookName];
      if (!param) return null;

      const chapter = extractChapter(title);
      if (chapter) {
        return `${BIBLE_APP_URL}?${param}&${chapter}`;
      }
      return `${BIBLE_APP_URL}?${param}`;
    }

    async function doSearch(e) {
      e.preventDefault();

      const keyword = document.getElementById('keyword').value.trim();
      const book = document.getElementById('book').value;
      const output = document.getElementById('output');
      const btn = document.getElementById('searchBtn');

      if (!keyword) {
        output.innerHTML = '<div class="error">Please enter a search keyword</div>';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Searching...';
      output.innerHTML = '<div class="loading">Searching commentary...</div>';

      try {
        const params = new URLSearchParams({ q: keyword });
        if (book) params.append('b', book);

        const response = await fetch(`${API_URL}?${params}`);
        const data = await response.json();

        if (data.error) {
          output.innerHTML = `<div class="error">${data.error}</div>`;
          return;
        }

        if (!data.results || data.results.length === 0) {
          output.innerHTML = `<div class="no-results">No matches found for "${keyword}"</div>`;
          return;
        }

        let html = `<div class="stats">Found ${data.totalMatches} matches in ${data.fileCount} files</div>`;
        html += '<div class="results">';

        for (const result of data.results) {
          const bibleLink = getBibleLink(result.book, result.title);
          const titleHtml = bibleLink
            ? `<a href="${bibleLink}" class="result-title" target="_blank">${result.title}</a>`
            : `<span class="result-title">${result.title}</span>`;
          html += `
            <div class="result-item">
              <div class="result-header">
                ${titleHtml}
                <span class="result-book">${result.book}</span>
              </div>
              <div class="result-count">${result.count} matches</div>
              ${result.contexts.map(ctx =>
                `<div class="context">${ctx}</div>`
              ).join('')}
            </div>
          `;
        }

        html += '</div>';
        output.innerHTML = html;

      } catch (err) {
        output.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Search';
      }
    }

    // Allow pressing Enter in the keyword field
    document.getElementById('keyword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        doSearch(e);
      }
    });
  </script>
</body>
</html>
